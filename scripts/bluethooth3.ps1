##################################################
# Meraki Bluetooth
$APIKey = 'Some API Key'
$OrgName = "Some Name"

##################################################

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

$headers = @{
    'Content-Type'    = 'application/json'
    "X-Cisco-Meraki-API-Key" = $APIKey
}
clear 

Write-Host "Getting Orgs" -ForegroundColor Green
$MerakiOrg = Invoke-RestMethod -Method Get -Uri 'https://api.meraki.com/api/v0/organizations' -Headers $headers
Write-Host "Getting Networks" -ForegroundColor Green
$Networks = Invoke-RestMethod -Method Get -Uri "https://api.meraki.com/api/v0/organizations/$($($MerakiOrg | Where-Object name -CLike "*$OrgName*").id)/networks" -Headers $headers

if ($Networks -ne $null) {
$Devices = @()
Write-Host "Finding all bluetooth devices" -ForegroundColor Green
foreach ($Net in $Networks) {
$MerakiDevices = Invoke-RestMethod -Method Get -Uri "https://api.meraki.com/api/v0/networks/$($Net.id)/devices" -Headers $headers
if ($($MerakiDevices | Where-Object model -CLike "MR*") -ne $null) {
$Bluetooth = Invoke-RestMethod -Method Get -Uri "https://api.meraki.com/api/v0/networks/$($Net.id)/bluetoothClients" -Headers $headers
#if ($Bluetooth -ne $null) {break}
foreach ($Device in $Bluetooth) {
$DeviceInfo = New-Object System.Object
$DeviceInfo | Add-Member -type NoteProperty -name Name -Value $Device.deviceName
$DeviceInfo | Add-Member -type NoteProperty -name Mac -Value $Device.mac
$Devices += $DeviceInfo

}
}
}
if ($Devices -ne $null) {$Devices} else {write-host "no devices found, remember not all bluetooth devices publish pubicly" -ForegroundColor Yellow}
}