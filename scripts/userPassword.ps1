$secedit_cfg = [System.IO.Path]::GetTempFileName();
$secedit_path = "$env:SystemRoot\system32\secedit.exe";
$secedit_export = "/export /cfg $secedit_cfg /quiet";
$secedit_import = "/configure /db $env:SystemRoot\Security\local.sdb /cfg $secedit_cfg /areas SecurityPolicy";

Start-Process -FilePath $secedit_path -ArgumentList $secedit_export -Wait;

$old_security_policy = Get-Content $secedit_cfg;
$new_security_policy = $old_security_policy -Replace "MinimumPasswordLength = \d+", "MinimumPasswordLength = $password_minimun_length";

$password_minimun_length = 0;
Set-Content -Path $secedit_cfg -Value $new_security_policy;
Start-Process -FilePath $secedit_path -ArgumentList $secedit_import -Wait;

$BlankPasswordsFoundWording_PreUsername = "Found user account";
$BlankPasswordsFoundWording_PostUsername = "with a blank password.";
$NoBlankPasswordsFoundWording = "No user accounts with blank passwords found.";


$VBS_IdentifyBlankPasswords_Commands = @"
On Error Resume Next

Dim strComputerName
Dim strPassword

strComputerName = WScript.CreateObject("WScript.Network").ComputerName
strPassword = ""

Set LocalAccounts = GetObject("WinNT://" & strComputerName)
LocalAccounts.Filter = Array("user")

Dim Flag
Flag = 0 

For Each objUser In LocalAccounts
    objUser.ChangePassword strPassword, strPassword
    If Err = 0 or Err = -2147023569 Then
        Flag = 1
        Wscript.Echo "User:""" & objUser.Name & """ "
    End If
    Err.Clear
Next

If Flag = 0 Then
    WScript.Echo "$NoBlankPasswordsFoundWording"
End If
"@

$VBS_IdentifyBlankPasswords_File_Path_TMP = [System.IO.Path]::GetTempFileName();
$VBS_IdentifyBlankPasswords_File_Directory = (Get-ChildItem $VBS_IdentifyBlankPasswords_File_Path_TMP).DirectoryName;
$VBS_IdentifyBlankPasswords_File_Name_TMP = (Get-ChildItem $VBS_IdentifyBlankPasswords_File_Path_TMP).Name;
$VBS_IdentifyBlankPasswords_File_Name_VBS = $VBS_IdentifyBlankPasswords_File_Name_TMP + ".vbs";
$VBS_IdentifyBlankPasswords_File_Path_VBS = "$VBS_IdentifyBlankPasswords_File_Directory\$VBS_IdentifyBlankPasswords_File_Name_VBS";

Set-Content -Path $VBS_IdentifyBlankPasswords_File_Path_VBS -Value $VBS_IdentifyBlankPasswords_Commands;

$VBS_IdentifyBlankPasswords_Output = & cscript /nologo $VBS_IdentifyBlankPasswords_File_Path_VBS;


$UsersWithBlankPasswords = $VBS_IdentifyBlankPasswords_Output | Select-String -Pattern "User:";

If ($UsersWithBlankPasswords -NE $Null){
    ForEach ($UserWithBlankPassword in $UsersWithBlankPasswords){
        Write-Output "FIND USERS WITHOUT PASSWORD";
        $Username = [regex]::match($UserWithBlankPassword, '"([^"]+)"').Groups[1].Value;
        Write-Output "$Username";
    }
}
Set-Content -Path $secedit_cfg -Value $old_security_policy;
Start-Process -FilePath $secedit_path -ArgumentList $secedit_import -Wait;

