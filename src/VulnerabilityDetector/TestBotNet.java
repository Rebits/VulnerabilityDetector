/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package VulnerabilityDetector;

/**
 *
 * @author rebits
 */
import java.util.List;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

 public class TestBotNet extends Test{
     
    public TestBotNet(Map testData) {
        super(testData);
    }

    @Override
    void createResult() {
    JSONParser parser = new JSONParser();
        try {
   /*         String temp = "{\n" +
"	\"ip\": \"4.23.2.1.34\",\n" +
"	\"error\": \"\",\n" +
"	\"evidences\": [{\n" +
"		\"name\": \"Zeus\",\n" +
"		\"threatCode\": \"6M\",\n" +
"		\"operatingSystems\": [{\n" +
"			\"operatingSystem\": \"Linux\",\n" +
"			\"disinfectURL\": \"http://www.limpia.es\"\n" +
"		}],\n" +
"\n" +
"		\"descriptionURL\": \"http://www.info.com\",\n" +
"		\"timestamp\": \"2019-01-01 02:00:19\"\n" +
"	}]\n" +
"}";
          */  
            JSONObject api_response = (JSONObject) parser.parse(result.output.get(0));
             //JSONObject api_response;
             //api_response = (JSONObject) parser.parse(temp);

            /*
                ip: Dirección IP desde la que se recibe la petición.
                error: cadena con el texto del error en caso de que se produzca, o cadena vacía si no hay error.
                evidences: lista de amenazas asociadas a la IP.
               name: nombre de la amenaza.
               operatingSystems: lista de sistemas operativos a los que afecta la amenaza.
               → operatingSystem: sistema operativo.
               → disinfectUrl: dirección url con la información de
               desinfección.
               » descriptionUrl: url con la información general de la
               amenaza.
               » timestamp: fecha y hora determinada de la última vez
               que se detectó que la dirección IP estaba asociada a esta
               amenaza.            
            */
            List<Map> evidences = (List<Map>) api_response.get("evidences");
            
            String error = (String) api_response.get("error");
            if(error.length() != 0){
                result.message = "Error in request to BotNet API- " +  error;
                result.resultCode =  Integer.toString(-1);
                result.severity =  Integer.toString(0);
            }
            else{
                if(evidences.size() == 0 ){
                    result.message = "Ninguna amenaza relacionada con botnet detectada";
                    result.resultCode =  Integer.toString(0);
                    result.severity =  Integer.toString(0);
                }
                else{
                    result.message = "\n\nAmenazas detectadas\n";
                    for (int i = 0; i < evidences.size();i++) {
                        result.message += "-\tNombre de la amenaza: " + (String) (evidences.get(i)).get("name")  + "\n";

                        List<Map> operative_system = (List<Map>) evidences.get(i).get("operatingSystems");
                         result.message += "-\tSistemas operativos que afecta: \n";
                        for(int j = 0; j < operative_system.size();j++){
                             result.message += "\t\t" + operative_system.get(j).get("operatingSystem") + "\t----> \t URL para desinfección:   " + operative_system.get(j).get("disinfectURL") + "\n"; 
                        }
                        result.message += "URL con descripción de la amenaza:  " + evidences.get(i).get("descriptionURL") + "\n";
                    }
                    result.resultCode =  Integer.toString(0);
                    result.severity =  Integer.toString(3);
                }
            } 

        } catch (ParseException ex) {
            Logger.getLogger(TestBotNet.class.getName()).log(Level.SEVERE, null, ex);
        } 
    }
}