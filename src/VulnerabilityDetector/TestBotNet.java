/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package VulnerabilityDetector;

/**
 *
 * @author rebits
 */
import java.util.List;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

 public class TestBotNet extends Test{
     
    public TestBotNet(Map testData) {
        super(testData);
    }

    @Override
    void createResult() {
    JSONParser parser = new JSONParser();
        try {
            JSONObject api_response = (JSONObject) parser.parse(result.output.get(0));
            List<Map> evidences = (List<Map>) api_response.get("evidences");
            
            String error = (String) api_response.get("error");
            if(error.length() != 0){
                result.message = "Error in request to BotNet API- " +  error;
                result.resultCode =  Integer.toString(-1);
                result.severity =  Integer.toString(0);
            }
            else{
                if(evidences.size() == 0 ){
                    result.message = "Ninguna amenaza relacionada con botnet detectada";
                    result.resultCode =  Integer.toString(0);
                    result.severity =  Integer.toString(0);
                }
                else{
                    result.message = "\n\nAmenazas detectadas\n";
                    for (int i = 0; i < evidences.size();i++) {
                        result.message += "-\tNombre de la amenaza: " + (String) (evidences.get(i)).get("name")  + "\n";

                        List<Map> operative_system = (List<Map>) evidences.get(i).get("operatingSystems");
                         result.message += "-\tSistemas operativos que afecta: \n";
                        for(int j = 0; j < operative_system.size();j++){
                             result.message += "\t\t" + operative_system.get(j).get("operatingSystem") + "\t----> \t URL para desinfección:   " + operative_system.get(j).get("disinfectURL") + "\n"; 
                        }
                        result.message += "URL con descripción de la amenaza:  " + evidences.get(i).get("descriptionURL") + "\n";
                    }
                    result.resultCode =  Integer.toString(0);
                    result.severity =  Integer.toString(3);
                }
            } 

        } catch (ParseException ex) {
            Logger.getLogger(TestBotNet.class.getName()).log(Level.SEVERE, null, ex);
        } 
    }
}