/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package VulnerabilityDetector;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;


import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

/**
 *
 * @author Víctor Rebollo Pérez
 */
//


// Leerá de un archivo un Map de la siguiente forma:

/*
    [
        SO:[Windows,Ubuntu,etc]
        VulnerabilityName:
        VulnerabilityID:
        command_executer : ""
        commands: ["",""]
        Tier: ["",""]
    ]
*/


public class VulnerabilityScan {
    String OS;
    String version;
    List<Test> tests;

    public VulnerabilityScan() throws ClassNotFoundException, NoSuchMethodException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, InstantiationException{
        OS = System.getProperty("os.name").toLowerCase();
        version = System.getProperty("os.version");
        tests = new ArrayList<>();
        JSONParser parser = new JSONParser();
        try {    
            Object obj = parser.parse(new FileReader("testData.json"));
            
            List<JSONObject> jsonArray =  (List<JSONObject>) obj;
            for (JSONObject json : jsonArray) {
                Class act = null;
                Constructor con = null;
                String className = "VulnerabilityDetector.Test" + (String) json.get("VulnerabilityName"); //+ (String) json.get("VulnerabilityName");
                try {
                   act = Class.forName(className);
                } catch (ClassNotFoundException e) {
                       e.printStackTrace();
               }
                try {
                 con = act.getConstructor(Map.class);
                    } catch (Exception e) {
                       e.printStackTrace();
               } 
                
                Test newtest = (Test)con.newInstance(json);
                tests.add(newtest);
            }
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        } catch (ParseException e) {
            e.printStackTrace();
        }
    } 
    public TestResult runTest(String test) throws NoSuchMethodException, IllegalAccessException, IllegalArgumentException, InvocationTargetException{
        TestResult result = null;
        for(Test t : tests){
            if(t.VulnerabilityName == test){
                result = t.runTest(OS);
            }
        }
        return result;
    }
    public List<TestResult> runAllTests() throws NoSuchMethodException, IllegalAccessException, IllegalArgumentException, InvocationTargetException{
        List<TestResult> all_result = new ArrayList<>() ;
        for (Test t : tests) {
            t.runTest(OS);
            all_result.add(t.getResult());
        }
        return all_result;
    }
    /*
    public List<TestResult> runTierTest(List<String> list_tests){
        
        List<TestResult> result =  new ArrayList<>() ; ;
        for(Test t : tests){
            if(t.VulnerabilityName == test){
                result = t.runTest(OS);
            }
        }
        return result;
    }
*/
    public String createReport(List<TestResult> result){
        return "";
    }
    
}
    